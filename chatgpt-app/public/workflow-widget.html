<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Workflow Wizard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #0f172a;
    }
    .container {
      max-width: 820px;
      margin: 0 auto;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      padding: 26px;
    }
    h1 { color: #4f46e5; margin-bottom: 16px; font-size: 26px; }
    .info-box {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 10px;
      padding: 14px 42px 14px 14px;
      margin-bottom: 18px;
      font-size: 14px;
      line-height: 1.55;
      color: #5c4402;
      position: relative;
    }
    .info-close {
      position: absolute;
      top: 10px;
      right: 10px;
      border: none;
      background: transparent;
      color: #b7791f;
      font-size: 18px;
      cursor: pointer;
      line-height: 1;
    }
    .section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    .section:last-child { border-bottom: none; }
    label {
      display: block;
      font-weight: 650;
      margin-bottom: 8px;
      color: #111827;
      font-size: 13px;
    }
    input[type="text"], select, textarea {
      width: 100%;
      padding: 11px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 13px;
      transition: border-color 0.2s;
      font-family: inherit;
      background: #fff;
    }
    input[type="text"]:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #6366f1;
    }
    textarea { resize: vertical; min-height: 92px; }
    textarea.large { min-height: 190px; }
    textarea.readonly { background: #f3f4f6; cursor: not-allowed; }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border: none;
      padding: 11px 16px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
      margin-top: 12px;
    }
    button + button { margin-left: 10px; }
    button:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(102,126,234,0.35); }
    button:disabled { opacity: 0.55; cursor: not-allowed; transform: none; box-shadow: none; }
    button.secondary { background: #334155; }
    .button-group { display: flex; gap: 10px; flex-wrap: wrap; }
    .status {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 13px;
      display: none;
    }
    .status.success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; display: block; }
    .status.error { background: #fee2e2; color: #7f1d1d; border: 1px solid #fecaca; display: block; }
    .status.info { background: #dbeafe; color: #1e3a8a; border: 1px solid #bfdbfe; display: block; }
    .next-steps-box {
      background: #e7f3ff;
      border: 2px solid #2196F3;
      border-radius: 12px;
      padding: 14px;
      margin-top: 16px;
    }
    .next-steps-box label { color: #1976D2; font-size: 15px; }
    .hint {
      font-size: 12px;
      color: #475569;
      margin-top: 6px;
      line-height: 1.4;
    }
    .completion-box {
      background: #f4f8ff;
      border: 2px solid #c7d2fe;
      border-radius: 12px;
      padding: 14px 18px;
      margin-bottom: 12px;
    }
    .completion-box ol {
      padding-left: 18px;
      color: #1e293b;
      font-size: 14px;
      line-height: 1.6;
    }
    .completion-box li { margin-bottom: 6px; }
    .field-group + .field-group { margin-top: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <div id="infoBox" class="info-box">
      ChatGPT Projects underst√∏tter ikke Apps/Connectors endnu. √Öben wizard i en normal chat og flyt chatten til et projekt, n√•r opgaven er afsluttet.
      <button id="dismissInfoBtn" class="info-close" type="button" aria-label="Skjul besked">√ó</button>
    </div>

    <h1>Workflow Wizard</h1>

    <div class="section">
      <label>System</label>
      <select id="systemType">
        <option value="Natively">Natively</option>
        <option value="Base44">Base44</option>
      </select>
    </div>

    <div class="section">
      <label>Paste specs/brief</label>
      <textarea id="pastedText" class="large" placeholder="Inds√¶t hele beskrivelsen af problemet/feature, scope, constraints og indsatte filer"></textarea>

      <div class="button-group">
        <button id="generateBtn" type="button">Generer prompt</button>
      </div>
      <div id="genStatus" class="status"></div>
    </div>

    <div class="section">
      <div class="field-group">
        <label>Navn p√• opgaven</label>
        <input id="taskName" type="text" placeholder="fx ‚ÄúFix dashboard filters i Base44‚Äù" />
      </div>

      <div class="field-group">
        <label>Mode</label>
        <select id="copilotMode">
          <option value="agent">Agent</option>
          <option value="edit">Edit</option>
        </select>
      </div>

      <div class="field-group">
        <label>Copilot model</label>
        <input id="copilotModel" type="text" placeholder="Udfyldes automatisk" readonly />
      </div>

      <label style="margin-top:12px;">Copilot prompt</label>
      <textarea id="output" class="large readonly" readonly></textarea>

      <div class="button-group" style="margin-top:0;">
        <button id="copyPromptBtn" type="button" class="secondary">Copy Copilot prompt</button>
      </div>

      <div class="next-steps-box">
        <label>‚úÖ N√¶ste skridt</label>
        <textarea id="nextSteps" class="readonly" readonly></textarea>
      </div>

      <div class="hint">‚ÄúN√¶ste skridt‚Äù viser iterationstrinnene fra generate_prompt. Test-cyklus vises f√∏rst n√•r opgaven er ved at blive afsluttet.</div>
    </div>

    <div class="section">
      <label>Svar fra Copilot</label>
      <textarea id="copilotAnswer" class="large" placeholder="Inds√¶t Copilots svar her..."></textarea>

      <label style="margin-top:12px;">Indhold af √¶ndrede filer</label>
      <textarea id="changedFiles" class="large" placeholder="Inds√¶t hele indholdet af de √¶ndrede filer her (1:1)"></textarea>

      <div id="statusSection" style="display:none; margin-top:12px;">
        <label>Status</label>
        <select id="issueStatus">
          <option value="not_solved">Ikke l√∏st</option>
          <option value="solved">L√∏st</option>
        </select>

        <div id="commentWrapper" style="display:none; margin-top:12px;">
          <label>Kommentar</label>
          <textarea id="statusComment" placeholder="Forklar hvorfor opgaven ikke er l√∏st"></textarea>
        </div>
      </div>

      <div class="button-group">
        <button id="sendBtn" type="button">Send</button>
      </div>
      <div id="sendStatus" class="status"></div>
    </div>

    <div id="completionSection" class="section" style="display:none;">
      <label>Afslutning af opgave</label>
      <div class="completion-box">
        <ol>
          <li>Commit √¶ndringerne med en pr√¶cis besked (fx ‚Äúfix: login redirect bug‚Äù).</li>
          <li>Merge din branch ind i main: git checkout main ‚Üí git pull ‚Üí git merge &lt;branch&gt; ‚Üí git push.</li>
          <li>Slet feature-branchen b√•de lokalt og remote, s√• repoet holdes rent.</li>
          <li>Pull seneste main p√• din maskine og verificer, at alt bygger og virker.</li>
        </ol>
      </div>
      <button id="completionDoneBtn" type="button">Udf√∏rt</button>
      <div id="completionMessage" class="hint" style="display:none; font-weight:600;"></div>
    </div>
  </div>

  <script>
    const INFO_BOX_KEY = 'workflow_info_box_dismissed_v2';
    const SOLVED_TRIGGER_PHRASE = 'bug/feature l√∏st';
    const TEST_CYCLE_TEXT =
      'üîÅ TEST-CYKLUS\n' +
      '1) K√∏r komplette tests (unit/e2e) + manuel QA p√• de ber√∏rte flows.\n' +
      '2) Dokument√©r resultater (screenshots, logs, forventet vs faktisk).\n' +
      '3) Bekr√¶ft at alt matcher acceptance criteria f√∏r merge.\n';

    const els = {
      infoBox: document.getElementById('infoBox'),
      dismissInfoBtn: document.getElementById('dismissInfoBtn'),
      systemType: document.getElementById('systemType'),
      taskName: document.getElementById('taskName'),
      copilotMode: document.getElementById('copilotMode'),
      pastedText: document.getElementById('pastedText'),
      generateBtn: document.getElementById('generateBtn'),
      copyPromptBtn: document.getElementById('copyPromptBtn'),
      genStatus: document.getElementById('genStatus'),
      copilotModel: document.getElementById('copilotModel'),
      output: document.getElementById('output'),
      nextSteps: document.getElementById('nextSteps'),
      copilotAnswer: document.getElementById('copilotAnswer'),
      changedFiles: document.getElementById('changedFiles'),
      statusSection: document.getElementById('statusSection'),
      issueStatus: document.getElementById('issueStatus'),
      commentWrapper: document.getElementById('commentWrapper'),
      statusComment: document.getElementById('statusComment'),
      sendBtn: document.getElementById('sendBtn'),
      sendStatus: document.getElementById('sendStatus'),
      completionSection: document.getElementById('completionSection'),
      completionDoneBtn: document.getElementById('completionDoneBtn'),
      completionMessage: document.getElementById('completionMessage')
    };

    const state = { closurePhaseActive: false };

    function showStatus(el, message, type='info') {
      el.textContent = message;
      el.className = `status ${type}`;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 4500);
    }

    function safeParseJSON(text) {
      try { return JSON.parse(text); } catch { return null; }
    }

    function tryExtractStructured(obj) {
      if (!obj || typeof obj !== 'object') return null;
      const result = {};
      let found = false;
      if (typeof obj.outputText === 'string') { result.outputText = obj.outputText; found = true; }
      if (typeof obj.nextStepsText === 'string') { result.nextStepsText = obj.nextStepsText; found = true; }
      if (typeof obj.copilotModel === 'string') { result.copilotModel = obj.copilotModel; found = true; }
      if (found) return result;
      if (obj.structuredContent && typeof obj.structuredContent === 'object') {
        return tryExtractStructured(obj.structuredContent);
      }
      return null;
    }

    function extractFromContentArray(content) {
      if (!Array.isArray(content)) return null;
      for (const item of content) {
        if (item?.type === 'text' && typeof item.text === 'string') {
          const parsed = safeParseJSON(item.text);
          const extracted = tryExtractStructured(parsed);
          if (extracted) return extracted;
        }
      }
      return null;
    }

    function deriveStructuredContent(resp) {
      const candidates = [
        resp?.structuredContent,
        resp?.structured_content,
        resp?.toolOutput,
        window?.openai?.toolOutput,
        resp?.result,
        resp?.data
      ];
      for (const candidate of candidates) {
        const extracted = tryExtractStructured(candidate);
        if (extracted) return extracted;
      }
      return extractFromContentArray(resp?.content);
    }

    function initInfoBox() {
      let dismissed = false;
      try { dismissed = localStorage.getItem(INFO_BOX_KEY) === '1'; } catch {}
      if (dismissed) {
        els.infoBox.style.display = 'none';
      }
    }

    els.dismissInfoBtn.addEventListener('click', () => {
      els.infoBox.style.display = 'none';
      try { localStorage.setItem(INFO_BOX_KEY, '1'); } catch {}
    });

    function resetClosurePhaseUI() {
      state.closurePhaseActive = false;
      els.statusSection.style.display = 'none';
      els.issueStatus.value = 'not_solved';
      els.commentWrapper.style.display = 'none';
      els.statusComment.value = '';
      hideCompletionSection();
    }

    function hideCompletionSection() {
      els.completionSection.style.display = 'none';
      els.completionMessage.style.display = 'none';
      els.completionMessage.textContent = '';
      els.completionDoneBtn.disabled = false;
    }

    function updateCommentVisibility() {
      if (!state.closurePhaseActive) {
        els.commentWrapper.style.display = 'none';
        els.statusComment.value = '';
        return;
      }
      if (els.issueStatus.value === 'not_solved') {
        els.commentWrapper.style.display = 'block';
      } else {
        els.commentWrapper.style.display = 'none';
        els.statusComment.value = '';
      }
      if (els.issueStatus.value !== 'solved') {
        hideCompletionSection();
      }
    }

    function enterClosurePhase() {
      if (state.closurePhaseActive) return;
      state.closurePhaseActive = true;
      els.statusSection.style.display = 'block';
      els.nextSteps.value = TEST_CYCLE_TEXT;
      updateCommentVisibility();
      showStatus(els.sendStatus, 'Afslutningsfase aktiveret ‚Äì udfyld status f√∏r n√¶ste svar.', 'info');
    }

    els.issueStatus.addEventListener('change', updateCommentVisibility);

    els.completionDoneBtn.addEventListener('click', () => {
      els.completionDoneBtn.disabled = true;
      els.completionMessage.textContent = '√Öbn en ny chat for n√¶ste opgave og skriv open_wizard.';
      els.completionMessage.style.display = 'block';
    });

    async function generatePrompt() {
      const taskName = els.taskName.value.trim();
      const pasted = els.pastedText.value.trim();
      if (!taskName) {
        showStatus(els.genStatus, 'Udfyld ‚ÄúNavn p√• opgaven‚Äù f√∏rst', 'error');
        return;
      }
      if (!pasted) {
        showStatus(els.genStatus, 'Inds√¶t specs/brief f√∏rst', 'error');
        return;
      }

      const payload = {
        taskName,
        copilotMode: els.copilotMode.value,
        systemType: els.systemType.value,
        pastedText: els.pastedText.value
      };

      els.generateBtn.disabled = true;
      els.copilotModel.value = '';
      showStatus(els.genStatus, 'Genererer...', 'info');

      try {
        if (!window.openai?.callTool) {
          throw new Error('window.openai.callTool findes ikke i denne host');
        }
        const resp = await window.openai.callTool('generate_prompt', payload);
        const structured = deriveStructuredContent(resp);

        if (!structured) {
          const debugPayload = JSON.stringify(resp ?? {}, null, 2) || '';
          els.output.value = debugPayload.slice(0, 8000);
          els.nextSteps.value = '';
          showStatus(els.genStatus, 'Kunne ikke l√¶se tool output ‚Äì debug sat i output-feltet', 'error');
          return;
        }

        resetClosurePhaseUI();
        els.output.value = structured.outputText || '';
        els.nextSteps.value = structured.nextStepsText || '';
        const model = (structured.copilotModel || 'GPT-5.1-Codex').trim();
        els.copilotModel.value = model;

        showStatus(els.genStatus, '‚úÖ Prompt klar', 'success');
      } catch (err) {
        console.error(err);
        showStatus(els.genStatus, `Fejl: ${err.message || err}`, 'error');
      } finally {
        els.generateBtn.disabled = false;
      }
    }

    els.generateBtn.addEventListener('click', generatePrompt);

    els.copyPromptBtn.addEventListener('click', async () => {
      const text = els.output.value;
      if (!text) {
        showStatus(els.genStatus, 'Intet at kopiere', 'error');
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        showStatus(els.genStatus, 'Copilot prompt kopieret', 'success');
      } catch {
        showStatus(els.genStatus, 'Kunne ikke kopiere', 'error');
      }
    });

    function buildFollowUpMessage(includeStatus) {
      let payload =
        'Svar fra Copilot:\n' +
        (els.copilotAnswer.value.trim() || '(intet indsat)') +
        '\n\n' +
        'Indhold af √¶ndrede filer:\n' +
        (els.changedFiles.value.trim() || '(intet indsat)');
      if (includeStatus) {
        const statusText = els.issueStatus.value === 'solved' ? 'L√∏st' : 'Ikke l√∏st';
        payload += `\n\nStatus: ${statusText}`;
        if (els.issueStatus.value === 'not_solved') {
          payload += `\nKommentar: ${els.statusComment.value.trim() || '(ingen kommentar)'}`;
        }
      }
      return payload;
    }

    els.sendBtn.addEventListener('click', async () => {
      const includeStatus = state.closurePhaseActive;
      const followUp = buildFollowUpMessage(includeStatus);
      els.sendBtn.disabled = true;
      showStatus(els.sendStatus, 'Sender til ChatGPT...', 'info');

      try {
        const sender = window.openai?.sendFollowUpMessage || window.openai?.sendFollowupMessage;
        if (!sender) throw new Error('sendFollowUpMessage findes ikke i denne host');
        await sender({ prompt: followUp });
        showStatus(els.sendStatus, '‚úÖ Sendt', 'success');

        const lowerAnswer = els.copilotAnswer.value.toLowerCase();
        if (!state.closurePhaseActive && lowerAnswer.includes(SOLVED_TRIGGER_PHRASE)) {
          enterClosurePhase();
        }
        if (state.closurePhaseActive && els.issueStatus.value === 'solved') {
          els.completionSection.style.display = 'block';
        }
      } catch (err) {
        console.error(err);
        try {
          await navigator.clipboard.writeText(followUp);
          showStatus(els.sendStatus, 'Kunne ikke sende. Teksten er kopieret til clipboard.', 'error');
        } catch {
          showStatus(els.sendStatus, `Fejl: ${err.message || err}`, 'error');
        }
      } finally {
        els.sendBtn.disabled = false;
      }
    });

    initInfoBox();
  </script>
</body>
</html>
